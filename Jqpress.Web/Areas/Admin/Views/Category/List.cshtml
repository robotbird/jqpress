@using Jqpress.Framework.Mvc
@model Jqpress.Web.Areas.Admin.Models.CateListModel
@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "分类管理 - 管理中心 - Powered by Jqpress";
}

<script type="text/javascript">
    //修改操作
    function getJsonData(id) {
        $.getJSON('@Url.Action("Edit", "Category",new{dt=DateTime.Now})', { id: id }, function (json) {
            $("#CateName").val(json.CateName);
            $("#PageName").val(json.PageName);
            $("#Description").val(json.Description);


            $("select#ParentId option[value='" + json.ParentId + "']").attr('selected', 'true');
            $("#CategoryId").val(json.CategoryId);
            $("#submit").text("修改");
            $(".formzone").show("slow");
        });
    }
    //删除操作
    function deleteRow(id) {
        if (confirm('删除分类不会删除所属的文章,确定要删除吗?')) {
            $.ajax({
                url: '@Url.Action("Delete", "Category",new{dt=DateTime.Now})',
                data: { id: id },
                success: function (msg) {
                    $("#row" + id).fadeOut(500);
                }
            });
        }
    }

    $(document).ready(function () {

        //初始化表单
        function InitForm() {
            $(':text').each(function (i, n) { n.value = ''; });
            $("select#ParentId option[value='0']").attr('selected', 'true');

            $('#CategoryId').each(function (i, n) { n.value = ''; });
            $("#submit").text("添加");
        }

        //添加事件
        $("#addbtn").click(function () {
            if ($(".formzone").css("display") == "none") {
                InitForm();
                $(".formzone").show("slow");
            } else {
                $(".formzone").hide("slow");
            }
        });
        //绑定删除事件
        $(".odd td .delete").bind("click", function () { deleteRow(this.id); });
        //绑定修改事件
        $(".gradeX td .edit").bind("click", function () { getJsonData(this.id); });

        //取消事件
        $("#btncancle").click(function () {
            if ($(".formzone").css("display") == "none") {
                InitForm();
                $(".formzone").show("slow");
            } else {
                $(".formzone").hide("slow");
            }
        });
        //保存事件
        $('#form1').submit(function () {
            if ($("#CateName").val() == '') {
                alert("请填写名称");
                return false;
            }
            var act = "add";
            if ($("#CategoryId").val() != '') { act = "update"; }

            jQuery.ajax({
                type: 'POST', // 设置请求类型为 ‘POST’，默认为 ‘GET’
                url: '@Url.Action("Save", "Category",new{dt=DateTime.Now})', //
                data: $('#form1').serialize(), // 从表单中获取数据  
                beforeSend: function () { },
                error: function (XMLHttpRequest, textStatus, errorThrown) { alert(textStatus); },
                dataType: 'json',
                success: function (data) {
                    var _tr = "<tr class='odd gradeX'  id='row" + data.CategoryId + "'>";
                    _tr += " <td>" + data.TreeChar + " <a href='" + data.Url + "' >" + data.CateName + "</a></td>";
                    _tr += " <td><a href='" + data.Url + "' >" + data.PageName + "</a></td>";
                    _tr += " <td>" + data.Description + "</td>";
                    _tr += " <td>" + data.PostCount + "</td>";
                    _tr += "<td><a class='edit' href='javascript:getJsonData(" + data.CategoryId + ")' id='" + data.CategoryId + "'>编辑</a> <a class='delete' href='javascript:deleteRow(" + data.CategoryId + ")'  id='" + data.CategoryId + "'>删除</a></td>";
                    _tr += "</tr>";
                    InitForm();
                    $(".formzone").hide("slow");
                    if (act == "update") {
                        $("#row" + data.CategoryId).replaceWith(_tr);
                    } else {
                        if (data.ParentId > 0) {
                            $("#row" + data.ParentId).after(_tr);
                        } else {
                            $(".table").append(_tr);
                        }
                    }

                }
            });
            return false;
        });


    });
 
</script>

<!-- BEGIN PAGE HEADER-->
<div class="row">
<div class="col-md-12">
    <!-- BEGIN PAGE TITLE & BREADCRUMB-->
    <h3 class="page-title">
        分类 <small><a href="javascript:void(0)" id="addbtn" class="btn btn-sm btn-link">添加 <i class="icon-plus"></i></a></small>
    </h3>
    <!-- END PAGE TITLE & BREADCRUMB-->
</div>
</div>
<!-- END PAGE HEADER-->
    @Html.JPartial("_Notifications")


 <form id="form1" action="">

<div class="portlet-body formzone form" style="display:none;">
     <input type="hidden"  id="CategoryId" name="CategoryId"  />

    <div class="form-body">
                           
        <div class="form-group">
            <label for="CateName">名称：</label>
            <input type="text" id="CateName" name="CateName" class="form-control input-medium"   />
            <span>名称需要填写的</span>
        </div>

        <div class="form-group">
            <label for="CategoryId">父类：</label>
            @Html.DropDownList("ParentId", Model.CateSelectItem, new { @class = "form-control input-medium",  })
            <span>分类目录和标签不同，它可以有层级关系</span>
        </div>
        <div class="form-group">
            <label for="PageName">别名：</label>
            <input type="text" id="PageName" name="PageName"  class="form-control input-medium"   />
            <span>“别名”是对于 URL 友好的一个别称。它通常为小写并且只能包含字母，中文，数字和连字符（-）。</span>
        </div>

        <div class="form-group"  >
        <label for="Description">描述：</label>
            <textarea name="Description" rows="3" cols="38" id="Description" class="form-control input-medium"  ></textarea>
            <span>描述不一定会显示，但是他是很友好的提示。</span>
        </div>
                         
        <div class="form-group">
            <button type="submit" name="btnEdit"  onclick="return checkForm();" id="submit" class="btn btn-primary" >添加</button>
            <button type="button"  id="btncancle"  class="btn btn-default"  >取消 </button>
        </div>


    </div>

</div>
</form>

 <div class="portlet-body">
          <table class="table table-striped table-bordered table-hover" >
            <thead>
                <tr>
                <th>名称</th>
                <th>别名</th>
                <th>描述</th>
                <th>文章数量</th>
                <th>操作</th>
                </tr>
            </thead>
            <tbody>

                @foreach(var item in Model.CateList)
                {
                    <tr class="odd gradeX" id="row@(item.CategoryId)" >
                    <td>@item.TreeChar <a href="@item.Url" > @item.CateName</a></td>
                    <td><a href="@item.Url" > @item.PageName</a></td>
                    <td>@item.Description</td>
                    <td>@item.PostCount</td>
                    <td><a class="edit" href="javascript:void(0)" id="@item.CategoryId">编辑</a> <a class="delete" onclick="return confirm('删除分类不删除对应的文章,确定要删除吗?');" href="delete?id=@item.CategoryId">删除</a></td>
                    </tr>
                }

            </tbody>
          </table>
</div>


   <script type="text/javascript" src="/assets/plugins/data-tables/jquery.dataTables.js"></script>
   <script type="text/javascript" src="/assets/plugins/data-tables/DT_bootstrap.js"></script>
      <script src="/assets/scripts/app.js"></script>
   <script src="/assets/scripts/table-managed.js"></script>     
   <script>
       jQuery(document).ready(function () {
           App.init();
           TableManaged.init();
       });
   </script>
